<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eco-Travel Tunisia üåø</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0fdf4; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .hero { background: linear-gradient(135deg, #198754, #20c997); color: white; padding: 40px 0; border-radius: 0 0 30px 30px; margin-bottom: 30px; }
        .card { border: none; border-radius: 15px; transition: transform 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px rgba(0,0,0,0.1); }
        .eco-badge { background-color: #e8f5e9; color: #2e7d32; font-weight: bold; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; }
        .price-tag { font-size: 1.2rem; color: #198754; font-weight: bold; }
        .co2-tag { font-size: 0.85rem; color: #dc3545; } /* Red for CO2 warning */
        .co2-tag.low { color: #198754; } /* Green for low CO2 */
        
        /* AI Typing Effect */
        #ai-response { min-height: 30px; font-weight: 500; color: #d1e7dd; margin-top: 15px; transition: all 0.3s ease; }
    </style>
</head>
<body>

    <!-- üåø Header -->
    <div class="hero text-center">
        <h1 class="fw-bold">üåø Eco-Travel Tunisia</h1>
        <p class="opacity-75">Discover sustainable accommodations with low carbon footprint.</p>
        
        <!-- Search Bar -->
        <div class="container mt-4" style="max-width: 650px;">
            <div class="input-group input-group-lg shadow-sm">
                <!-- Input updated to encourage Natural Language -->
                <input type="text" id="chatInput" class="form-control border-0" placeholder="Ask AI: 'Cheap hotel in Djerba' or 'Best eco-lodge...'">
                <button class="btn btn-light text-success fw-bold px-4" onclick="sendChat()">Ask AI ü§ñ</button>
            </div>
            <!-- AI Response Area -->
            <div id="ai-response"></div>
        </div>
    </div>

    <!-- Recommendations Section -->
    <div class="container mb-5">
        <h2 class="fw-bold mb-3">Our Top Eco-Picks üåü</h2>
        <div id="recommendations-grid" class="row g-4">
            <!-- Recommendations will be injected here -->
        </div>
        <hr class="my-5">
    </div>

    <!-- üè® Hotel Grid -->
    <div class="container mb-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="fw-bold mb-0">All Accommodations</h2>
            <div class="d-flex align-items-center">
                <button class="btn btn-success me-3" onclick="openAddModal()">+ Add New</button>
                <label for="city-filter" class="form-label me-2 mb-0">Filter by City:</label>
                <select id="city-filter" class="form-select" style="width: auto;" onchange="filterHotelsByCity()">
                    <!-- City options will be injected here -->
                </select>
            </div>
        </div>
        <div id="hotel-grid" class="row g-4">
            <!-- Hotels will be injected here by JavaScript -->
            <div class="text-center text-muted py-5">
                <div class="spinner-border text-success" role="status"></div>
                <p class="mt-2">Loading eco-friendly spots...</p>
            </div>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div class="modal fade" id="accommodationModal" tabindex="-1" aria-labelledby="accommodationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="accommodationModalLabel">Add Accommodation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="accommodationForm">
                        <input type="hidden" id="originalName" name="originalName">
                        <div class="mb-3">
                            <label for="name" class="form-label">Name</label>
                            <input type="text" class="form-control" id="name" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="city" class="form-label">City</label>
                            <input type="text" class="form-control" id="city" name="city" required>
                        </div>
                        <div class="mb-3">
                            <label for="type" class="form-label">Type</label>
                            <select class="form-select" id="type" name="type" required>
                                <option value="Hotel">Hotel</option>
                                <option value="EcoLodge">EcoLodge</option>
                                <option value="Camping">Camping</option>
                                <option value="Hiking">Hiking</option>
                                <option value="Diving">Diving</option>
                                <option value="Workshop">Workshop</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="price" class="form-label">Price (TND)</label>
                                <input type="number" class="form-control" id="price" name="price" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="rating" class="form-label">Rating (1-5)</label>
                                <input type="number" class="form-control" id="rating" name="rating" min="1" max="5" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="co2" class="form-label">CO2 Footprint (kg)</label>
                            <input type="number" class="form-control" id="co2" name="co2" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="saveAccommodation()">Save changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- üß† JavaScript Logic -->
    <script>
        // Base URL for Flask
        const API_BASE = "http://127.0.0.1:5000";
        let accommodationModal;

        // 1. Load All Data on Startup
        window.onload = async function() {
            accommodationModal = new bootstrap.Modal(document.getElementById('accommodationModal'));
            // Fetch recommendations, all hotels, and cities in parallel
            try {
                const [recoResponse, hotelsResponse, citiesResponse] = await Promise.all([
                    fetch(`${API_BASE}/recommendations`),
                    fetch(`${API_BASE}/hotels`),
                    fetch(`${API_BASE}/cities`)
                ]);
                
                const recoData = await recoResponse.json();
                const hotelsData = await hotelsResponse.json();
                const citiesData = await citiesResponse.json();

                renderHotels(recoData, 'recommendations-grid');
                renderHotels(hotelsData, 'hotel-grid');
                populateCityFilter(citiesData);

            } catch (error) {
                console.error("Failed to load data:", error);
                showError('recommendations-grid');
                showError('hotel-grid');
            }
        };

        // New function to populate the city filter dropdown
        function populateCityFilter(cities) {
            const filter = document.getElementById('city-filter');
            const currentCity = filter.value;
            filter.innerHTML = '<option value="all">All Cities</option>'; // Start with an "All" option
            cities.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                if(city === currentCity) {
                    option.selected = true;
                }
                filter.appendChild(option);
            });
        }

        // New function to fetch and render hotels based on city selection
        async function filterHotelsByCity() {
            const selectedCity = document.getElementById('city-filter').value;
            const grid = document.getElementById('hotel-grid');
            grid.innerHTML = `<div class="text-center text-muted py-5"><div class="spinner-border text-success" role="status"></div><p class="mt-2">Loading...</p></div>`;
            try {
                const response = await fetch(`${API_BASE}/hotels?city=${selectedCity}`);
                const data = await response.json();
                renderHotels(data, 'hotel-grid');
            } catch (error) {
                console.error("Failed to filter hotels:", error);
                showError('hotel-grid');
            }
        }

        // 2. Send Chat to AI (now only affects the main grid)
        async function sendChat() {
            const inputField = document.getElementById("chatInput");
            const userText = inputField.value.trim();
            const responseArea = document.getElementById("ai-response");
            const grid = document.getElementById("hotel-grid");

            if (!userText) return; // Don't send empty

            // UI: Show Loading state
            responseArea.innerHTML = "ü§ñ <i>Thinking...</i>";
            grid.style.opacity = "0.5";

            try {
                const response = await fetch(`${API_BASE}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: userText })
                });

                const result = await response.json();

                // UI: Update AI Text
                responseArea.innerHTML = `ü§ñ "${result.response}"`;
                grid.style.opacity = "1";

                // UI: Render filtered results into the main grid
                renderHotels(result.data, 'hotel-grid');

            } catch (error) {
                console.error(error);
                responseArea.innerHTML = "‚ùå Error connecting to AI.";
                grid.style.opacity = "1";
            }
        }

        // 3. Render Cards Function (Now with CRUD buttons)
        function renderHotels(hotels, gridId) {
            const grid = document.getElementById(gridId);
            if (!grid) return; // Safety check
            grid.innerHTML = ""; // Clear previous results

            if (!hotels || hotels.length === 0) {
                grid.innerHTML = `<div class="col-12 text-center text-muted py-5"><h3>üö´ No results found.</h3><p>Try a different search or add a new accommodation!</p></div>`;
                return;
            }

            const columnClass = (gridId === 'recommendations-grid') ? 'col-md-3' : 'col-lg-4 col-md-6';

            hotels.forEach(hotel => {
                const leaves = "üçÉ".repeat(hotel.rating) + "‚ö™".repeat(5 - hotel.rating);
                const co2Class = hotel.co2 < 20 ? "low" : "";
                
                // Escape hotel data for safe insertion into HTML attributes
                const hotelData = Object.fromEntries(Object.entries(hotel).map(([k, v]) => [k, String(v).replace(/'/g, "&apos;").replace(/"/g, "&quot;")]));


                const cardHTML = `
                    <div class="${columnClass} mb-4">
                        <div class="card h-100">
                            <div class="card-body d-flex flex-column">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <span class="eco-badge text-uppercase">${hotelData.city}</span>
                                    <a href="details.html?name=${encodeURIComponent(hotelData.name)}" style="text-decoration: none; color: inherit;">
                                        <span class="text-success" title="${hotelData.rating} Stars">${leaves}</span>
                                    </a>
                                </div>
                                <a href="details.html?name=${encodeURIComponent(hotelData.name)}" style="text-decoration: none; color: inherit;">
                                    <h5 class="card-title fw-bold mb-3">${hotelData.name}</h5>
                                </a>
                                
                                <div class="mt-auto">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <div class="price-tag">${hotelData.price} TND <span class="text-muted fs-6">/night</span></div>
                                        <div class="co2-tag ${co2Class} fw-bold">üí® ${hotelData.co2} kg CO2</div>
                                    </div>
                                    ${gridId === 'hotel-grid' ? `
                                    <hr>
                                    <div class="d-flex justify-content-end">
                                        <button class="btn btn-sm btn-outline-primary me-2" onclick="openEditModal('${hotelData.name}', '${hotelData.city}', '${hotelData.type}', '${hotelData.price}', '${hotelData.rating}', '${hotelData.co2}')">Edit</button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteAccommodation('${hotelData.name}')">Delete</button>
                                    </div>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                grid.insertAdjacentHTML('beforeend', cardHTML);
            });
        }
        
        // 4. CRUD Functions
        function openAddModal() {
            document.getElementById('accommodationForm').reset();
            document.getElementById('accommodationModalLabel').textContent = 'Add New Accommodation';
            document.getElementById('originalName').value = '';
            accommodationModal.show();
        }

        function openEditModal(name, city, type, price, rating, co2) {
            document.getElementById('accommodationForm').reset();
            document.getElementById('accommodationModalLabel').textContent = `Edit ${name}`;
            document.getElementById('originalName').value = name;
            document.getElementById('name').value = name;
            document.getElementById('city').value = city;
            document.getElementById('type').value = type;
            document.getElementById('price').value = price;
            document.getElementById('rating').value = rating;
            document.getElementById('co2').value = co2;
            accommodationModal.show();
        }

        async function saveAccommodation() {
            const form = document.getElementById('accommodationForm');
            const originalName = document.getElementById('originalName').value;
            const isEdit = originalName !== '';
            
            const data = {
                name: form.name.value,
                city: form.city.value,
                type: form.type.value,
                price: parseFloat(form.price.value),
                rating: parseInt(form.rating.value),
                co2: parseFloat(form.co2.value)
            };

            const url = isEdit ? `${API_BASE}/accommodation/${encodeURIComponent(originalName)}` : `${API_BASE}/accommodation`;
            const method = isEdit ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                accommodationModal.hide();
                await Promise.all([filterHotelsByCity(), fetchAndPopulateCities()]); // Refresh data

            } catch (error) {
                console.error('Failed to save accommodation:', error);
                alert('Failed to save. Check console for details.');
            }
        }
        
        async function deleteAccommodation(name) {
            if (!confirm(`Are you sure you want to delete "${name}"?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/accommodation/${encodeURIComponent(name)}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                await Promise.all([filterHotelsByCity(), fetchAndPopulateCities()]); // Refresh data

            } catch (error) {
                console.error('Failed to delete accommodation:', error);
                alert('Failed to delete. Check console for details.');
            }
        }

        async function fetchAndPopulateCities() {
             try {
                const citiesResponse = await fetch(`${API_BASE}/cities`);
                const citiesData = await citiesResponse.json();
                populateCityFilter(citiesData);
            } catch(error) {
                 console.error("Failed to load cities:", error);
            }
        }

        function showError(gridId) {
            const grid = document.getElementById(gridId);
            if (!grid) return;
            grid.innerHTML = `
                <div class="col-12 text-center">
                    <div class="alert alert-danger d-inline-block">
                        ‚ùå <b>Connection Failed</b><br>
                        Could not load data. Is the server running?
                    </div>
                </div>`;
        }

        // Allow "Enter" key to submit
        document.getElementById("chatInput").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                sendChat();
            }
        });
    </script>
</body>
</html>